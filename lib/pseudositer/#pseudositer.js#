(function() {

  /*
  Pseudositer 0.0.4 content management for the lazy
  
  kudos to coffee-plate https://github.com/pthrasher/coffee-plate
  
  To use pseudositer, call the plugin upon an HTML element with an argument for
  the path to your content.
  
  Read the documentation at http://www.github.com/talos/pseudositer for other
  options.
  
  You can use the following boilerplate to get pseudositer running.
  Substitute the path to your content in place of "path/to/content/index/",
  and the paths to your javascript libraries as appropriate:
  
  <html>
    <head>
  
      <!-- jQuery -->
      <script type="text/javascript" src="lib/jquery/jquery-1.6.4.min.js"></script>
  
      <!-- pseudositer -->
      <script type="text/javascript" src="lib/pseudositer/pseudositer.js"></script>
      <script type="text/javascript">
        $(document).ready(function() {
            $('#pseudositer').pseudositer('path/to/content/index/');
        });
     </script>
    </head>
    <body>
      <div id="pseudositer" />
    </body>
  </html>
  */

  var __slice = Array.prototype.slice;

  (function($) {
    /*
      #
      # Static constant events
      #
    */
    var contentClass, createIndex, destroyIndex, errorClass, events, getClassForPath, getContentContainer, getCurrentFragment, getCurrentPath, getIndexClassForLevel, getIndexTrail, getSuffix, hideContent, hideError, hideLoadingNotice, indexClass, linkClass, loadImage, loadText, loadingClass, log, showContent, showError, showLoadingNotice, staleClass;
    events = ['update.pseudositer', 'start.loading.pseudositer', 'failed.loading.pseudositer', 'done.loading.pseudositer', 'always.loading.pseudositer', 'destroy.index.pseudositer', 'create.index.pseudositer', 'load.image.pseudositer', 'load.text.pseudositer', 'hide.content.pseudositer', 'show.content.pseudositer', 'show.error.pseudositer'];
    /*
      #
      # Static class names for default handlers
      #
    */
    contentClass = 'pseudositer-content';
    staleClass = 'pseudositer-stale';
    indexClass = 'pseudositer-index';
    loadingClass = 'pseudositer-loading';
    errorClass = 'pseudositer-error';
    linkClass = 'pseudositer-link';
    /*
      #
      # Static functions
      #
    */
    log = function(obj) {
      if ((typeof console !== "undefined" && console !== null ? console.log : void 0) != null) {
        console.log(obj);
      }
      return;
    };
    getCurrentPath = function() {
      var path;
      return path = document.location.pathname;
    };
    getCurrentFragment = function() {
      var fragment;
      return fragment = document.location.hash.substr(1);
    };
    getIndexTrail = function(path) {
      var ary, i, trail, _ref;
      ary = path.split('/');
      trail = ['/'];
      for (i = 1, _ref = ary.length - 1; 1 <= _ref ? i < _ref : i > _ref; 1 <= _ref ? i++ : i--) {
        trail.push(ary.slice(0, i + 1 || 9e9).join('/') + '/');
      }
      return trail;
    };
    getSuffix = function(path) {
      var fileName, splitByDot, splitBySlash;
      splitBySlash = path.split('/');
      fileName = splitBySlash[splitBySlash.length - 1];
      splitByDot = fileName.split('.');
      if (splitByDot.length > 1) {
        return splitByDot[splitByDot.length - 1].toLowerCase();
      } else {
        return null;
      }
    };
    getContentContainer = function($pseudositer) {
      var $container;
      $container = $('.' + contentClass);
      if ($container.length === 0) {
        $container = $('<div />').addClass(contentClass).appendTo($pseudositer);
      }
      return $container;
    };
    getIndexClassForLevel = function(level) {
      return indexClass + '-' + level;
    };
    getClassForPath = function(path) {
      return path.replace(/[^A-Za-z0-9]/g, '-');
    };
    /*
      #
      # Default handlers -- these are all called with the pseudositer object
      # as this.
      #
    */
    showLoadingNotice = function(spawningPath) {
      var $container, $loadingNotice, classForPath;
      $container = getContentContainer(this);
      classForPath = getClassForPath(spawningPath);
      $loadingNotice = $('<div />').hide().text("Loading " + spawningPath + "...").addClass("" + loadingClass + " " + classForPath).appendTo($container).fadeIn('fast');
      return;
    };
    hideLoadingNotice = function(spawningPath) {
      var $elem, classForPath;
      classForPath = getClassForPath(spawningPath);
      $elem = $("." + loadingClass + "." + classForPath).fadeOut('fast', function() {
        return $elem.remove();
      });
      return;
    };
    destroyIndex = function(dfd, aboveIndexLevel) {
      var $index, $indices, destroyed, _i, _len;
      $indices = $('.' + indexClass);
      destroyed = new $.Deferred().resolve();
      for (_i = 0, _len = $indices.length; _i < _len; _i++) {
        $index = $indices[_i];
        if ($index.data('pseudositer').level > aboveIndexLevel) {
          destroyed = destroyed.pipe(function() {
            return $index.fadeOut('slow', function() {
              $index.remove();
              return destroyed.resolve();
            });
          });
        }
      }
      destroyed.done(function() {
        return dfd.resolve();
      });
      return;
    };
    createIndex = function(dfd, path, $links) {
      var $index, indexLevel, levelClass, prevPath;
      indexLevel = path.split('/').length - 2;
      levelClass = getIndexClassForLevel(indexLevel);
      $index = $('.' + levelClass);
      if ($index.length === 0) {
        $index = $('<div />').addClass(indexClass + ' ' + levelClass).data('pseudositer', {}).hide();
        this.append($index);
      }
      prevPath = $index.data('pseudositer').path;
      if (path === prevPath) {
        dfd.resolve();
      } else {
        $index.data('pseudositer', fadeOut('slow', function() {
          return $index.empty().data('pseudositer', {
            path: path,
            level: indexLevel
          }).append($links.fadeIn('slow', function() {
            return dfd.resolve();
          }));
        }));
      }
      return;
    };
    loadImage = function(dfd, pathToImage) {
      var $img, $tmp;
      log("loadImage( " + dfd + ", " + $elem + ", " + pathToImage + " )");
      $tmp = $('<div />').style({
        height: '0px',
        width: '0px'
      }).appendTo($('body'));
      $img = $('<a />').attr('href', pathToImage).append($('<img />').attr('src', pathToImage).bind('onload', function() {
        dfd.resolve($img);
        return $tmp.remove();
      }));
      return;
    };
    loadText = function(dfd, pathToText) {
      log("loadText( " + $elem + ", " + pathToText + " )");
      dfd = new $.Deferred();
      $.get(pathToText).done(function(responseText) {
        return dfd.resolve($('<div />').text(responseText));
      }).fail(function(errObj) {
        return dfd.reject(errObj);
      });
      return;
    };
    hideContent = function(dfd, $elem) {
      var $content;
      $content = getContentContainer(this).children();
      $content.fadeOut('slow', function() {
        $content.remove();
        return dfd.resolve();
      });
      return;
    };
    showContent = function(dfd, $elem) {
      var $container;
      $container = getContentContainer(this);
      $elem.hide().appendTo($container).fadeIn('slow', function() {
        return dfd.resolve();
      });
      return;
    };
    showError = function(errObj) {
      var $error;
      log("showError( " + errObj + " )");
      log(errObj);
      $error = $('.' + errorClass);
      if ($error.length === 0) {
        $error = $('<div />').addClass(errorClass).appendTo(getContentContainer(this));
      }
      $error.text(errObj.toString()).fadeIn('fast');
      return;
    };
    hideError = function() {
      var $error;
      $error = $('.' + errorClass);
      $error.fadeOut('fast', function() {
        return $error.text('');
      });
      return;
    };
    /*
      #
      # Plugin object
      #
    */
    $.pseudositer = function(el, hiddenPath, options, map) {
      var getAjaxPath, load, loadContent, loadIndex, showIndices, trigger, unfold, update;
      var _this = this;
      this.$el = $(el);
      this.$el.data("pseudositer", this);
      this.pathIndices = {};
      this.cachedContent = {};
      this.init = function() {
        var event, handler, split, _i, _j, _len, _len2, _ref;
        _this.options = $.extend({}, $.pseudositer.defaultOptions, options);
        _this.map = $.extend({}, $.pseudositer.defaultMap, map);
        _this.visiblePath = getCurrentPath();
        if (!hiddenPath.charAt(hiddenPath.length - 1)) {
          hiddenPath = "" + hiddenPath + "/";
        }
        if (hiddenPath.charAt(0) === '/') {
          _this.realPath = hiddenPath;
        } else {
          if (getSuffix(_this.visiblePath) != null) {
            split = _this.visiblePath.split('/');
            _this.realPath = split.slice(0, (split.length - 1)).join('/') + '/' + hiddenPath;
          } else {
            if (_this.visiblePath.charAt(_this.visiblePath.length - 1) === '/') {
              _this.realPath = _this.visiblePath + hiddenPath;
            } else {
              _this.realPath = _this.visiblePath + '/' + hiddenPath;
            }
          }
        }
        $(window).bind('hashchange', update);
        for (_i = 0, _len = events.length; _i < _len; _i++) {
          event = events[_i];
          _ref = _this.options[event];
          for (_j = 0, _len2 = _ref.length; _j < _len2; _j++) {
            handler = _ref[_j];
            _this.$el.bind(event, function() {
              var args;
              args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
              return handler.apply(_this.$el, args);
            });
          }
        }
        update();
        return _this;
      };
      /*
          #
          # Public methods
          #
      */
      this.destroy = function() {
        $(window).unbind('hashchange', update);
        _this.$el.empty().unbind('.pseudositer');
        return _this;
      };
      /*
          #
          # Private methods.
          #
      */
      trigger = function() {
        var args, eventName;
        eventName = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
        _this.$el.triggerHandler("" + eventName + ".pseudositer", args);
        return _this;
      };
      getAjaxPath = function(path) {
        return _this.realPath + path.substr(1);
      };
      update = function() {
        var $content, contentHidden, contentShown, path;
        log("update( )");
        path = getCurrentFragment();
        if (path === '') {
          document.location.hash = '/';
          return;
        }
        trigger('update', path);
        $content = _this.cachedContent[path];
        if ($content != null) {
          showIndices(path);
          contentShown = new $.Deferred();
          contentHidden = new $.Deferred();
          trigger('hide.content', contentHidden);
          contentHidden.done(function() {
            return trigger('show.content', contentShown, $content);
          }).fail(function(errObj) {
            return trigger('show.error', errObj);
          });
        } else {
          load(path).done(function() {
            if (path === loadedPath) {
              return update();
            } else {
              return document.location.hash = loadedPath;
            }
          }).fail(function(errObj) {
            return trigger('show.error', errObj);
          });
        }
        return _this;
      };
      load = function(spawningPath) {
        var pathDfd, progress;
        log("load( " + spawningPath + " )");
        trigger('start.loading', spawningPath);
        if (_this.options.recursion === true) {
          pathDfd = unfold(spawningPath);
        } else {
          pathDfd = new $.Deferred(function() {
            return spawningPath;
          });
        }
        progress = new $.Deferred();
        pathDfd.done(function(path) {
          var contentPromise, dfd, indexPromise, trail, trails, _i, _len, _ref;
          contentPromise = loadContent(path);
          dfd = new $.Deferred().resolve().pipe(function() {
            return contentPromise;
          });
          trails = getIndexTrail(path);
          _ref = trails.slice(0, (trails.length - 1) + 1 || 9e9);
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            trail = _ref[_i];
            indexPromise = loadIndex(trail);
            dfd = dfd.pipe(function() {
              return indexPromise;
            });
          }
          return dfd.done(function() {
            return progress.resolve(path).fail(function(errObj) {
              return progress.reject(errObj);
            });
          });
        }).fail(function(errObj) {
          return progress.reject(errObj);
        });
        setTimeout((function() {
          return progress.reject("Timeout after " + _this.options.timeout + " ms");
        }), _this.options.timeout);
        progress.done(function(loadedPath) {
          return trigger('done.loading', spawningPath, loadedPath);
        }).fail(function(errObj) {
          return trigger('failed.loading', spawningPath);
        }).always(function() {
          return trigger('always.loading', spawningPath);
        });
        return progress.promise();
      };
      unfold = function(path, dfd) {
        if (dfd == null) dfd = new $.Deferred();
        log("unfold( " + path + ", " + dfd + " )");
        if (getSuffix(path) != null) {
          dfd.resolve(path);
        } else {
          loadIndex(path).done(function() {
            var $links;
            $links = _this.pathIndices[path];
            if ($links.length === 0) {
              return dfd.reject("" + path + " has no content");
            } else {
              return unfold($links.first().attr('href').substr(1), dfd);
            }
          }).fail(function(errObj) {
            return dfd.reject(errObj);
          });
        }
        return dfd.promise();
      };
      loadIndex = function(indexPath) {
        var dfd;
        log("loadIndex( " + indexPath + " )");
        dfd = new $.Deferred();
        if (_this.pathIndices[indexPath] != null) {
          dfd.resolve();
        } else {
          $.get(getAjaxPath(indexPath), function(responseText) {
            var $links;
            $links = $(responseText).find(_this.options.linkSelector).addClass(linkClass).attr('href', function(idx, oldValue) {
              if (oldValue.charAt(0) === '/') {
                return '#' + oldValue;
              } else {
                return '#' + indexPath + oldValue;
              }
            });
            return _this.pathIndices[indexPath] = $links;
          }).done(function() {
            return dfd.resolve();
          }).fail(function() {
            return dfd.reject("Could not load index page for " + indexPath);
          });
        }
        return dfd.promise();
      };
      loadContent = function(pathToContent) {
        var dfd, suffix;
        log("loadContent( " + pathToContent + " )");
        dfd = new $.Deferred();
        suffix = getSuffix(pathToContent);
        if (_this.map[suffix] != null) {
          trigger(_this.map[suffix], dfd, pathToContent);
          dfd.done(function($content) {
            _this.cachedContent[pathToContent] = $content;
            return dfd.resolve();
          }).fail(function(errObj) {
            return dfd.reject(errObj);
          });
        } else {
          dfd.reject("No handler for content type " + suffix);
        }
        return dfd.promise();
      };
      showIndices = function(path) {
        var $links, dfd, trails, _i, _len;
        log("showIndices( " + path + " )");
        dfd = new $.Deferred();
        trigger('destroy.index', dfd, trails.length);
        trails = getIndexTrail(path);
        $links = _this.pathIndices([path]);
        for (_i = 0, _len = trails.length; _i < _len; _i++) {
          path = trails[_i];
          dfd = dfd.pipe(function() {
            return trigger('create.index', dfd, $links);
          });
        }
        return dfd.promise();
      };
      return this.init();
    };
    $.pseudositer.defaultOptions = {
      linkSelector: 'a:not([href^="?"],[href^="/"])',
      'update.pseudositer': [hideError],
      'start.loading.pseudositer': [showLoadingNotice],
      'failed.loading.pseudositer': [],
      'done.loading.pseudositer': [],
      'always.loading.pseudositer': [hideLoadingNotice],
      'destroy.index.pseudositer': [destroyIndex],
      'create.index.pseudositer': [createIndex],
      'load.image.pseudositer': [loadImage],
      'load.text.pseudositer': [loadText],
      'hide.content.pseudositer': [hideContent],
      'show.content.pseudositer': [showContent],
      'show.error.pseudositer': [showError],
      timeout: 2000,
      recursion: true
    };
    $.pseudositer.defaultMap = {
      png: 'load.image',
      gif: 'load.image',
      jpg: 'load.image',
      jpeg: 'load.image',
      txt: 'load.text',
      html: 'load.text'
    };
    $.fn.pseudositer = function(hiddenPath, options, map) {
      if (map == null) map = {};
      if ((options != null ? options.map : void 0) != null) {
        $.extend(map, options.map);
      }
      return $.each(this, function(i, el) {
        var $el;
        $el = $(el);
        if (!$el.data('pseudositer')) {
          return $el.data('pseudositer', new $.pseudositer(el, hiddenPath, options, map));
        }
      });
    };
    return;
  })(jQuery);

}).call(this);
